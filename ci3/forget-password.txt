# ========= HTML ========= #
<?php include('include/header.php');?>
<style type="text/css">
legend.fs-title.p-2.text-center {
    background: antiquewhite;
}

.register-btn {
    background-color: #c31f04;
    color: #fff;
}

.register-btn:hover {
    background-color: #c31f04;
    color: #fff;
}

.forget_email {
    margin-bottom: 0px;
}
</style>
<div class="container p-5">
    <div class="row">
        <div class="col-md-6 mx-auto">
            <!-- Form 1 -->
            <form id="forget_password_form" method="post">
                <fieldset>
                    <div class="form-card">
                        <legend class="fs-title p-2 text-center">Forget Password</legend>

                        <br>

                        <div class="form-group forget_email">
                            <label for="email">Email <span style="color:red;">*</span></label>
                            <input type="email" class="form-control" placeholder="Enter email" id="email" name="email"
                                required>
                        </div>
                        <div class="alert alert-danger mt-3 email_error"><small class="text-danger">Email not found.
                                Please try again.</small></div>
                        <div class="alert alert-success mt-3 email_send"><small class="text-success">OTP sended
                                successfully. Please check email.</small></div>

                        <div class="form-group otp_field mt-2">
                            <label for="verify_otp">Enter OTP</label>
                            <input type="text" class="form-control" placeholder="Enter otp" id="verify_otp"
                                name="verify_otp" required>
                            <small id="otp_msg" class="mt-2"></small>
                        </div>


                        <div class="form-group text-center">
                            <input type="Submit" class="otp_btn btn mt-4" value="send" />
                        </div>

                </fieldset>
            </form>
            <!-- End Form 1 -->
        </div>
    </div>
</div>
<?php include('include/footer.php');?>
# ========= End HTML ========= # 



# ===== Script ======= #

$('.otp_field').hide();
$('.email_error').hide();
$('.email_send').hide();

 <!-- Forget Password Form Validation -->
     <script type="text/javascript">
$("#forget_password_form").validate({
    rules: {
        email: {
            required: true,
            email: true
        },
        // Specify validation error messages
        messages: {
            email: "Please enter a valid email address",
        },
    },
    // Make sure the form is submitted to the destination defined
    // in the "action" attribute of the form when valid
    submitHandler: function(form) {
        // send_otp_to_email();
        var isVerfyOtpVisible = $(".otp_field").is(":visible");
        if (!isVerfyOtpVisible) {
            send_otp_to_email();
        } else {
            verify_send_otp();
        }
    }
});

function send_otp_to_email() {
    var expform = document.getElementById('forget_password_form');
    var fd = new FormData(expform);
    $.ajax({
        type: "POST",
        url: "<?php echo base_url('action/send_otp_on_email'); ?>",
        data: fd,
        contentType: false,
        processData: false,
        success: function(data) {
            obj = $.parseJSON(data);

            if (obj.status == 'true') {
                $('.otp_field').show().fadeIn();
                $('.email_send').show().fadeIn();
            }

            if (obj.status == 'false') {
                $('.email_error').fadeIn();
                setTimeout(function() {
                    $('.email_error').hide().fadeOut();
                }, 3000);
            }
        },
        error: function() {
            alert('Some Error Occured.');
        }
    });
    return false;
}


function verify_send_otp() {
    $('#msg').html('');
    var expform = document.getElementById('forget_password_form');
    var fd = new FormData(expform);
    $.ajax({
        type: "POST",
        url: "<?php echo base_url('action/verify_otp'); ?>",
        data: fd,
        contentType: false,
        processData: false,
        success: function(data) {
            obj = $.parseJSON(data);

            if (obj.status == 'true') {
                var url = "<?= base_url('change_password');?>";
                // window.location.href = "<?= base_url('change_password');?>";
                window.location.replace(url);
            } else if (obj.status == 'false') {
                $('.email_send').hide();
                $('#otp_msg').html(
                    '<div class="alert alert-danger" role="alert">Incorrect Otp. Please enter correct otp.</div>'
                );

            }
        },
        error: function() {
            alert('Some Error Occured.');
        }
    });
    return false;
}
     </script>
     <!-- End Forget Password Form Validation -->
	 
	   <!-- Change Password -->
     <script type="text/javascript">
$("#change_password_form").validate({
    rules: {
        password: {
            required: true,
            minlength: 6
        },
        confirmPassword: {
            required: true,
            equalTo: "#password"
        }
    },
    // Specify validation error messages
    messages: {
        password: {
            required: "Please enter a password",
            minlength: "Your password must be at least 6 characters long"
        },
        confirmPassword: {
            required: "Please enter a password",
            equalTo: "Password not match."
        },
        email: "Please enter a valid email address"
    },
    // Make sure the form is submitted to the destination defined
    // in the "action" attribute of the form when valid
    submitHandler: function(form) {
        form.submit();
    }
});
     </script>
     <!-- End Change Password -->
	 # ===== End Script ======= #
	 
	 
	 # ======== PHP ============ #
	 
/*************** OTP CODE *********************/
    public function send_otp_on_email(){
        $email      = $this->input->post('email');
        $otp        = rand(10000,99999);
        $arr        = array(); 
            $this->db->where('email',$email);
            $row = $this->db->get('tbl_user');
            if($row->num_rows() > 0)
            {
                if($this->input->post())
                {
                    $data = array(
                        'reset_code'               => $otp          
                    );

                    $result = $this->Html_model->update_query($data,'tbl_user','email="'.$email.'"');
            
                    if($result != 0)
                    {
                     
                        $this->email->set_mailtype("html");
                        $this->email->set_newline("\r\n");
                   
                        $message  ="Title : Email For Forget Password"."\r\n";
                        $message .="Message : Your otp is ".$otp.". \r\n";

                        $this->email->from('info@documitra.gmail.com',"Documitra");
                        $this->email->to($email);
                        $this->email->subject("Enquiry From Website");
                        $this->email->message($message);
                        $this->email->send();
                    
                        $arr = array('status' => 'true', 'message' => 'OTP sent to email successfully.');
                       
                    }
                }
            }else
            {
                $arr = array('status'=>'false', 'message'=>'User not exits');
            }
            echo json_encode($arr);
}

    public function verify_otp(){
                    $user_email  = $this->input->post('email');
                    $user_otp    = $this->input->post('verify_otp');

                    $this->db->where('email',$user_email);
                    $row = $this->db->get('tbl_user');
                    if($row->num_rows() > 0)
                    {
                        $row_data      = $row->row();
                        $db_reset_code = $row_data->reset_code;
                        
                        if($db_reset_code == $user_otp):
                            $this->session->set_userdata('forget_password_email',$user_email); 
                            $this->session->set_userdata('session_msg','<div class="alert alert-success" role="alert">OTP verified succesfully.</div>');    
             
                            $result = array('status'=>'true','msg'=> 'OTP verified');                          
                        else:
                           $result = array('status'=>'false','msg'=> 'Invalid OTP');                          
                        endif;

                    }
                    else
                    {
                        $result = array('status'=>'false','msg'=> 'Some Error Occured.');                          
                    }

            echo json_encode($result);
        }

/*************** End OTP CODE *********************/    

/*************** CHANGE PASSWORD *********************/    
    public function change_password()
    {
      if($this->input->post())
      {
        $email        = $this->session->userdata('forget_password_email');
        $new_password = $this->input->post('password');
        $data = array(
                        'password'               => md5($new_password)          
                    );
   
        $result = $this->Html_model->update_query($data,'tbl_user','email="'.$email.'"');
        if($result)
        {

                $this->session->unset_userdata('forget_password_email');
                $this->session->set_userdata('session_msg','<div class="alert alert-success" role="alert">Password Succesfully Changed.</div>');
                redirect('login'); 
        }
        else
        {
                $this->session->set_userdata('session_msg','<div class="alert alert-danger" role="alert">Failed to changed password.</div>');
                redirect('change_password'); 
        }
               
      }
    } 
/*************** END CHANGE PASSWORD *********************/   
	 # ======== End PHP ======== #
	 
	 ************************************
	 Elmentor UI - V!kas123
	 ************************************